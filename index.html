<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset=utf8 />
        <link rel="icon" href="assets/favicon.ico" />
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <header>
            <h1>Quoi Faire Avec</h1>
        </header>
        <nav id="navigation">
        </nav> 
        <div id="contenu">
        </div>
    </body>
    <footer>
    </footer>

    <script>
        const commons = [
            navbar= {
                id: 'navigation',
                async render () {
                    let str = `<div class="left"><button onclick="router.navigate('accueil')">Accueil</button>`;
                    const con = await API.estConnecte();
                    if(con) {
                        str += `<button onclick="router.navigate('ListeReserves')">Réserves</button>`;
                        str += `<button onclick="router.navigate('creationIngredient')">Creation d'un ingrédients</button>`;
                        str += `</div>`;
                        str += `<div class="right"><button onclick="API.deconnection()">Déconnexion</button></div>`;
                    } else {
                        str += `</div><div class="right">`;
                        str += `<button onclick="router.navigate('inscriptionUtilisateur')">Inscription</button>`;
                        str += `<button onclick="router.navigate('connexionUtilisateur')">Connexion</button>`;
                        str += `</div>`;
                    }
                    document.getElementById('navigation').innerHTML = str;
                    }
            }
        ]

        const views = {
            accueil: {
                async render() {
                    let str =`
                <div class="accueil">
                <h2>Accueil</h2>
                <p><b>Bienvenue sur Quoi Faire Avec !</b><br/><br/> 
                    Libérez la puissance de votre créativité culinaire grâce à notre intelligence algorithmique de pointe, conçue pour sublimer chaque ingrédient oublié au fond de votre réfrigérateur. En fusionnant innovation technologique et gastronomie durable, notre plateforme transforme l’inventaire du quotidien en une expérience sensorielle inédite. Réinventez vos habitudes de consommation, réduisez votre empreinte carbone et rejoignez le mouvement de la Smart-Cuisine 2.0 dès aujourd’hui.</p><br/><br/>
                <button id="genererAleatoire" onclick="API.genererRecetteAleatoire()">Générer 5 recettes Aléatoire !</button>
                `
                const con = await API.estConnecte();
                if(con)
                {
                    str += `<button id="genererAvecIngredients" onclick="API.genererRecetteIngredients()">Générer 5 recettes avec vos ingrédients !</button>`;
                }
                return str + `</div>`;
                }      
            },
            creationReserve: {
                render: () => 
                `
                <h2>Creation d\'une réserve</h2>            
                <div class="formulaire">
                    <input type="text" id="nomReserve" placeholder="Nom de la réserve">
                    <button onclick="API.CreerReserve()">Créer</button>
                </div>
                `
            },
            creationIngredient: {
                render: () => 
                ` 
                <h2>Creation d\'un ingrédient</h2>            
                <div class="formulaire">
                    <input type="text" id="nomIngredient" placeholder="Nom de l'ingrédient">
                    <select name="unite" id="uniteIngredient">
                        <option value="mg">milligramme (mg)</option>
                        <option value="g" selected>gramme (g)</option>
                        <option value="kg">kilogramme (kg)</option>
                        <option value="lb">livre (lb)</option>
                        <option value="oz">once (oz)</option>
                        <option value="ml">millilitre (ml)</option>
                        <option value="cl">centilitre (cl)</option>
                        <option value="dl">décilitre (dl)</option>
                        <option value="l">litre (l)</option>
                        <option value="pincee">pincée</option>
                        <option value="pointe">pointe de couteau</option>
                        <option value="cc">cuillère à café</option>
                        <option value="cd">cuillère à dessert</option>
                        <option value="cs">cuillère à soupe</option>
                        <option value="tasse">tasse (cup)</option>
                        <option value="bol">bol</option>
                        <option value="verre">verre</option>
                        <option value="verre-a-moutarde">verre à moutarde</option>
                        <option value="louche">louche</option>
                        <option value="filet">filet</option>
                        <option value="trait">trait</option>
                        <option value="goutte">goutte</option>
                        <option value="unite">unité / pièce</option>
                        <option value="demi">demi</option>
                        <option value="quart">quart</option>
                        <option value="douzaine">douzaine</option>
                        <option value="botte">botte</option>
                        <option value="bouquet">bouquet</option>
                        <option value="gousse">gousse</option>
                        <option value="branche">branche</option>
                        <option value="zeste">zeste</option>
                        <option value="boite">boîte / conserve</option>
                        <option value="pot">pot</option>
                        <option value="sachet">sachet</option>
                        <option value="plaque">plaque (tablette)</option>
                        <option value="barquette">barquette</option>
                    </select>
                    <button onclick="API.CreerIngredient()">Créer</button>
                </div>
                ` 
            },
            connexionUtilisateur: {
                render: () =>
                `
                <h2>Connexion</h2>            
                <div class="formulaire">
                        <input type="text" id="login" placeholder="Login">
                        <input type="password" id="mdp" placeholder="Mot de passe">
                        <button onclick="API.ConnecterUtilisateur()">Connexion</button>
                </div>
                `
            },
            inscriptionUtilisateur: {
                render: () =>
                `
                <h2>Inscription</h2>
                <div class="formulaire">
                        <input type="text" id="login" placeholder="Login">
                        <input type="password" id="mdp" placeholder="Mot de passe">
                        <button onclick="API.InscrireUtilisateur()">Inscription</button>
                </div>
                `
            },
            ListeReserves: {
                async render() {
                    try {
                        let reserves = await API.getReserves();
                        if(reserves)
                        {
                            reserves = Array.isArray(reserves) ? reserves : [reserves[1]];
                            return `<button class="ajout" onclick="router.navigate('creationReserve')">+</button> Ajouter une réserve` + reserves.map(reserve => {
                                let str = 
                                `
                                <div class="reserve" id="reserve${reserve.numero}">
                                    <h3>${reserve.nom} <button onclick="router.navigate('ajouterIngredient')">Ajouter ingrédient</button></h3>
                                    <ul class="listeIngredients">`;
                                ingredients = Object.entries(reserve.lesIngredients);
                                str += ingredients.map(element => {
                                    const id = element[0];
                                    const ingredient = element[1];
                                    const unite = ingredient.quantite.unite == "u" ? "" : ingredient.quantite.unite;
                                    return `<li id="UL${reserve.numero}LI${id}" >${ingredient.nom} : <input type="number" id="${reserve.numero}-${id}" onchange="API.AjouterModifQuantite(${reserve.numero},${id})" value=${ingredient.quantite.valeur} min=0></input>${unite}<button class="supprimer" onclick="API.ajouterSuppression(${reserve.numero},${id})">-</button><br/></li>`
                                }).join('');
                                str += `<button class="sauvegarde" onclick="API.AppliquerModifs()">Sauvegarder</button></ul></div>`;
                                return str;
                            }
                            ).join('');
                        } else {
                            return '<div>Pas de réserves</div>';
                        }
                    } catch(error) {
                        return `<div class="errMess">${error.message}</div>`;
                    }
                }
            },
            ajouterIngredient: {
                async render () {
                    try {
                        listeIng = await API.ListeIngredients();
                        reserves = await API.getReserves();
                        if(reserves) {
                            reserves = Array.isArray(reserves) ? reserves : [reserves[1]];
                            let str=`
                            <h2>Ajouter un ingredient</h2>     
                                <div class="formulaire">
                                    <input type="text" id="recherche" list="lesIngredients" placeholder="ingredient">
                                    <input type="number" id="quantite" placeholder="quantite" value=1>
                                    <select id="reserve">`;
                            str += reserves.map(res => `<option value="${res.numero}">${res.nom}</option>`).join('');
                            str +=`
                                    </select>
                                    <button onclick="API.AjouterIngredient()">Ajouter ingrédient</button>
                                    <button onclick="router.navigate('ListeReserves')">retour aux reserves</button>
                                </div>`;
                                //TODO: refresh la liste des reserves au retour
                            str += `<datalist id="lesIngredients">`;
                            str += listeIng.map(ing => `<option value="${ing[1].nom}" label="${ing[1].nom} ${ing[1].quantite.unite == 'u' ? '' : `(${ing[1].quantite.unite})`}">${ing[1].nom}-(${ing[1].quantite.unite})</option>`).join('');
                            str += `</datalist>`;
                            return str;
                        } else {
                            return '<div>Pas de réserves</div>';
                        }
                    } catch(error) {
                        return `<div class="errMess">${error.message}</div>`;
                    }
                }
            }
        };

        class Router {
            constructor(routes) {
                this.routes = routes;
                this.currentRoute = null;
                this.init();
            }

            init() {
                window.addEventListener('hashchange', () => this.loadRoute());
                window.addEventListener('load', () => this.loadRoute());
            }

            loadRoute() {
                this.renderCommons(commons);
                const hash = window.location.hash.slice(1) || 'accueil';
                this.currentRoute = hash;
                if(this.routes[hash]) {
                    this.render(this.routes[hash]);
                } else {
                    this.render404();
                }
            }

            async render(view) {
                const contenu = document.getElementById('contenu');
                contenu.innerHTML = await view.render();
            }

            async renderCommons(commons) {
                commons.forEach(com => {
                    const element = document.getElementById(com.id);
                    com.render();
                });
            }

            render404() {
                const app = document.getElementById('contenu');
                app.innerHTML = `
                    <h2> Erreur 404</h2>
                    <p>La page demandée n'existe pas.</p>
                    <button onclick="router.navigate('accueil')">Retour à l'accueil</button>
                `;
            }

            navigate(route) {
                window.location.hash = route;
            }
        }

        const router = new Router(views);

        class API {
            static baseURL = window.location.href.split("QuoiFaireAvec")[0] + '/QuoiFaireAvec/api';
            static cooldown = false;
            static modifs = []; //liste des modifs a appliquer
            static token = null;
            
            static setToken(token) {
                this.token = token;
            }
            
            static getToken() {
                return this.token;
            }
            
            static clearToken() {
                this.token = null;
            }

            static getHeaders() {
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                const token = this.getToken();
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                return headers;
            }

            static async requeter(endpoint, options = {}) {
                const url = `${this.baseURL}${endpoint}`;
                const config = {
                    ...options,
                    headers: this.getHeaders()
                };
                
                try {
                    const res = await fetch(url, config);
                    if (!res.ok) {
                        const errorText = await res.text().catch(() => "");
                        return JSON.parse(errorText);
                    }
                    
                    if(config.method == 'GET') {
                        return await res.json();
                    } else {
                        return null;
                    }
                    
                    

                } catch (error) {
                    console.error('Erreur API:', error);
                    throw error;
                }
            }

            static miseEnPageRecettes(recettes) {
                return recettes.recettes.map(rec => {
                    let str =`
                    <div class="recettes"><h2>${rec.nom} : </h2>
                    <ul><h3>temps de préparation : </h3><li>${rec.temps_preparation}</li></ul>
                    <ul><h3>Ingredients :</h3>
                    `;
                    str += rec.ingredients.map(ing => `<li>${ing.nom} ${ing.quantite} ${ing.unite}</li>`).join('');
                    str += `
                    </ul>
                    <ul><h3>Preparation : </h3>`;
                    str += rec.instructions.map(ins => `<li>${ins}</li>`).join('');
                    str += `</ul></div>`;
                    return str;
                    }
                ).join('');
            }

            static deconnection() {
                if(document.cookie)
                {
                    document.cookie = `access_token=`;
                    document.cookie = `login=;`;
                    router.navigate('accueil');
                    location.reload();
                }
            }

            //#region GET

            static async ConnecterUtilisateur() {
                const login = document.getElementById('login').value;
                const mdp = document.getElementById('mdp').value;
                if (login && mdp) {
                    const ret = await this.requeter(`/visiteur/verifLoginMotDePasse?login=${login}&mdp=${mdp}`, {method: 'GET'});
                    const tkn = ret.access_token;
                    document.cookie = `access_token=${tkn}`;
                    document.cookie = `login=${login};`;
                    router.navigate('accueil');
                }
            }

            static async estConnecte() {
                if(document.cookie) {
                    const login = document.cookie.match(/login=([^;]+)/) ? document.cookie.match(/login=([^;]+)/)[1] : null;
                    const tkn = document.cookie.match(/access_token=([^;]+)/) ? document.cookie.match(/access_token=([^;]+)/)[1] : null;
                    if(login && tkn)
                    {
                        this.setToken(tkn);
                        const ret = await this.requeter(`/estConnecte?login=${login}`, {method: 'GET'});
                        if(ret.info == login) {
                            return true
                        }
                    }
                    return false;
                }
            }

            static async getReserves() {
                if(document.cookie) {
                    const login = document.cookie.match(/login=([^;]+)/) ? document.cookie.match(/login=([^;]+)/)[1] : null;
                    const tkn = document.cookie.match(/access_token=([^;]+)/) ? document.cookie.match(/access_token=([^;]+)/)[1] : null;
                    if(login && tkn)
                    {
                        this.setToken(tkn);
                        const ret = await this.requeter(`/utilisateur/getAllReserves?login=${login}`, {method: 'GET'});
                        return ret;
                    }
                    return null;
                }
            }

            static async genererRecetteAleatoire() {
                document.getElementById('contenu').innerHTML += `<div class="notif">Génération des recettes en cours ...</div>`;
                const recettes = await this.requeter(`/visiteur/getRecetteAleatoire`,{method: 'GET'});
                const notif = document.getElementsByClassName('notif')[0];
                if (notif) {
                    notif.remove();
                }
                document.getElementById('contenu').innerHTML += this.miseEnPageRecettes(recettes);
            }

            static async genererRecetteIngredients() {
                if(document.cookie) {
                    const login = document.cookie.match(/login=([^;]+)/) ? document.cookie.match(/login=([^;]+)/)[1] : null;
                    const tkn = document.cookie.match(/access_token=([^;]+)/) ? document.cookie.match(/access_token=([^;]+)/)[1] : null;
                    if(login && tkn) {
                        document.getElementById('contenu').innerHTML += `<div class="notif">Génération des recettes en cours ...</div>`;
                        const recettes = await this.requeter(`/utilisateur/getRecetteAvecListe?login=${login}`,{method: 'GET'});
                        const notif = document.getElementsByClassName('notif')[0];
                        if (notif) {
                            notif.remove();
                        }
                        document.getElementById('contenu').innerHTML += this.miseEnPageRecettes(recettes);
                    }
                }
            }

            static async ListeIngredients() {                
                return Object.entries(await this.requeter("/visiteur/getIngredients", {method: 'GET'}));
            }

            //#endregion

            //#region POST

            static async CreerReserve() {
                if(document.cookie) {
                    const login = document.cookie.match(/login=([^;]+)/) ? document.cookie.match(/login=([^;]+)/)[1] : null;
                    const tkn = document.cookie.match(/access_token=([^;]+)/) ? document.cookie.match(/access_token=([^;]+)/)[1] : null;
                    const nom = document.getElementById('nomReserve').value;
                    if(login && tkn && nom) {
                        this.setToken(tkn);
                        const body = JSON.stringify({login: login, nom: nom});
                        this.requeter(`/utilisateur/createReserve`,{method: 'POST', body: body});
                        router.navigate('ListeReserves');
                        location.reload();

                    }
                }
            }

            static async CreerIngredient() {
                if(document.cookie) {
                    const login = document.cookie.match(/login=([^;]+)/) ? document.cookie.match(/login=([^;]+)/)[1] : null;
                    const tkn = document.cookie.match(/access_token=([^;]+)/) ? document.cookie.match(/access_token=([^;]+)/)[1] : null;
                    const nom = document.getElementById('nomIngredient').value;
                    const unite = document.getElementById('uniteIngredient').value;
                    if(login && tkn && nom && unite) {
                        this.setToken(tkn);
                        const body = JSON.stringify({login: login, nom: nom, unite: unite});
                        this.requeter(`/utilisateur/createIngredient`,{method: 'POST', body: body});
                        document.getElementById('contenu').innerHTML += `<div class="notif">Ingredient <b>${nom}</b> créé</div>`;
                    }
                    document.getElementById('nomIngredient').value = null;
                    document.getElementById('uniteIngredient').value = null;
                }
            }
            
            static async InscrireUtilisateur() {
                const login = document.getElementById('login').value;
                const mdp = document.getElementById('mdp').value;
                if(login && mdp) {
                    const body = JSON.stringify({login: login, mdp: mdp});
                    const ret = await this.requeter(`/visiteur/creationUtilisateur`,{method: 'POST', body: body});
                    if(ret) {
                        document.getElementById('contenu').innerHTML += `<div class="notif">${ret["error"]}</div>`;
                        return;
                    }
                    API.ConnecterUtilisateur();

                }
            }

            static async AjouterIngredient() {
                const notif = document.getElementsByClassName('notif')[0];
                if (notif) {
                    notif.remove();
                }
                if(document.cookie) {
                    const login = document.cookie.match(/login=([^;]+)/) ? document.cookie.match(/login=([^;]+)/)[1] : null;
                    const tkn = document.cookie.match(/access_token=([^;]+)/) ? document.cookie.match(/access_token=([^;]+)/)[1] : null;
                    const quantite = document.getElementById('quantite').value;
                    const numero = document.getElementById('reserve').value;
                    const ingredient = document.getElementById('recherche').value;
                    if(login && tkn && quantite && numero && ingredient) {
                        const listeIng = await this.ListeIngredients();
                        let reserves = await this.getReserves();
                        reserves = Array.isArray(reserves) ? reserves : [reserves[1]];
                        
                        //TODO: probleme avec les unités ou jsp quoi
                        const unite = document.getElementById('lesIngredients').innerHTML.match(new RegExp(`${ingredient}-\\s*\\(([^)]+)\\)`))[1];
                        const ingTrouve = listeIng.find(ing => ing[1].nom == ingredient && ing[1].quantite.unite == unite);
                        if(ingTrouve) {
                            const idIngredient = ingTrouve[0];
                            let corresp = reserves.find(res => res.numero == numero).lesIngredients;
                            corresp = Object.entries(corresp).find(ing => ing[0] == idIngredient);
                            if(!corresp) {
                                const body = JSON.stringify({login: login, numero: numero, idIngredient: idIngredient, nombre: quantite});
                                this.requeter(`/utilisateur/ajouterIngredient`,{method: 'POST',body: body});
                                document.getElementById('recherche').value = null;
                                document.getElementById('quantite').value = 1;
                                document.getElementById('contenu').innerHTML += `<div class="notif">L'ingrédient <b>${ingTrouve[1].nom}</b> &agrave été ajouté</div>`
                            }
                            else {
                                document.getElementById('contenu').innerHTML += `<div class="notif">L'ingrédient <b>${corresp[1].nom}</b> est déj&agrave dans cette réserve</div>`
                            }
                        }
                        else {
                            document.getElementById('contenu').innerHTML += `<div class="notif">Ingrédient Inconnu</div>`

                        }
                    }
                }
            }

            //#endregion

            //#region PUT/DELETE

            static async AjouterModifQuantite(numero,idIngredient) {
                if(document.cookie) {
                    const login = document.cookie.match(/login=([^;]+)/) ? document.cookie.match(/login=([^;]+)/)[1] : null;
                    const tkn = document.cookie.match(/access_token=([^;]+)/) ? document.cookie.match(/access_token=([^;]+)/)[1] : null;
                    const quantite = document.getElementById(`${numero}-${idIngredient}`).value;
                    if(login && tkn) {
                        const body = JSON.stringify({login: login, numero: numero, idIngredient: idIngredient, nombre: quantite});
                        const contenu = {
                            id: idIngredient,
                            endpoint: `/utilisateur/modifierQuantite`,
                            method: 'PUT',
                            body: body
                        }
                        let insere = false;
                        this.modifs.forEach(mod => {
                            if(mod.id == idIngredient && mod.method == 'PUT') {
                                mod.body = body;
                                insere = true;
                            }
                        });
                        if(!insere) {
                            this.modifs.push(contenu);
                        }
                    }
                }
            }

            static async ajouterSuppression(numero,idIngredient) {
                if(document.cookie) {
                    const login = document.cookie.match(/login=([^;]+)/) ? document.cookie.match(/login=([^;]+)/)[1] : null;
                    const tkn = document.cookie.match(/access_token=([^;]+)/) ? document.cookie.match(/access_token=([^;]+)/)[1] : null;
                    if(login && tkn) {
                        const contenu = {
                            endpoint: `/utilisateur/supprimerIngredientDeReserve/${login}/${numero}/${idIngredient}`,
                            method: 'DELETE',
                            body: null,
                        }
                        document.getElementById(`UL${numero}LI${idIngredient}`).style.backgroundColor = "darkred";
                        document.getElementById(`UL${numero}LI${idIngredient}`).style.color = "white";
                        this.modifs.push(contenu);
                    }
                }
            }

            static async AppliquerModifs() {
                this.modifs.forEach(mod => {
                    this.requeter(mod.endpoint,{method: mod.method, body: mod.body});
                });
                
                this.modifs = [];
                location.reload();

            }

            //#endregion
        }

    </script>
</html>